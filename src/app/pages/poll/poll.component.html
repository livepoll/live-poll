<!--
  ~ Copyright Â© Live-Poll 2020. All rights reserved
  -->

<!-- Navigation breadcrumb -->
<nz-breadcrumb>
  <nz-breadcrumb-item>
    <a routerLink="/dashboard/home" nz-icon nzType="home"></a>
  </nz-breadcrumb-item>
  <nz-breadcrumb-item>
    <a routerLink="/dashboard/my-polls"><em>My Polls</em></a>
  </nz-breadcrumb-item>
  <nz-breadcrumb-item *ngIf="poll">
    <a [routerLink]="'/dashboard/my-polls/poll/' + poll.id"><em>{{poll.name}}</em></a>
  </nz-breadcrumb-item>
</nz-breadcrumb>

<!-- Page content -->
<nz-content style="margin-top: 10px">
  <nz-page-header *ngIf="!error && poll" class="site-page-header" (nzBack)="onBack()" nzBackIcon>
    <!--title-->
    <nz-page-header-title>{{poll.name}}</nz-page-header-title>

    <!--subtitle-->
    <nz-page-header-subtitle *ngIf="poll.startDate.getTime() !== 0 && poll.endDate.getTime() !== 0">
      {{poll.startDate | date:'short'}} - {{poll.endDate | date:'short'}}
    </nz-page-header-subtitle>
    <nz-page-header-subtitle *ngIf="poll.startDate.getTime() === 0 && poll.endDate.getTime() !== 0">
      Manual opening, closing automatically at {{poll.endDate | date:'short'}}
    </nz-page-header-subtitle>
    <nz-page-header-subtitle *ngIf="poll.startDate.getTime() === 0 && poll.endDate.getTime() !== 0">
      Opening automatically at {{poll.startDate | date:'short'}}, manual closing
    </nz-page-header-subtitle>
    <nz-page-header-subtitle *ngIf="poll.startDate.getTime() === 0 && poll.endDate.getTime() === 0">
      Manual opening / closing
    </nz-page-header-subtitle>

    <!--tags-->
    <nz-page-header-tags>
      <nz-tag *ngIf="poll.startDate > currentDate || poll.endDate.getTime() === 0" nzColor="orange">
        <i nz-icon nzType="clock-circle"></i>
        <span>Planned</span>
      </nz-tag>
      <nz-tag *ngIf="poll.startDate < currentDate && poll.endDate > currentDate" nzColor="green">
        <i nz-icon nzType="loading"></i>
        <span>Running</span>
      </nz-tag>
      <nz-tag *ngIf="poll.endDate < currentDate && poll.endDate.getTime() !== 0" nzColor="purple">
        <i nz-icon nzType="check"></i>
        <span>Finished</span>
      </nz-tag>
    </nz-page-header-tags>

    <!--extra-->
    <nz-page-header-extra>
      <button nz-button nzType="dashed" nz-popconfirm nzPopconfirmTitle="Are you sure you want to delete this poll?"
              nzPopconfirmPlacement="bottom" (nzOnConfirm)="deletePoll()" nzDanger>
        <i nz-icon nzType="delete"></i>Delete
      </button>
      <button nz-button><i nz-icon nzType="edit"></i>Edit</button>
      <button nz-button nzType="primary" [nzLoading]="changingState" (click)="changePollState(!poll.open)">
        {{poll.open ? 'Close' : 'Open'}}
      </button>
    </nz-page-header-extra>

    <!--content-->
    <nz-page-header-content>
      <div nz-row>
        You can share this URL with your participants:&nbsp;
        <p style="color: #38C6BC">
          {{host}}/p/
          <span nz-typography nzCopyable nzEditable [nzContent]="poll.snippet" (nzContentChange)="onUrlChange($event)"
                [nzCopyText]="host + '/' + poll.snippet" style="margin-left: -2px; color: #38C6BC"></span>
        </p>
        <nz-tabset class="content" style="width: 100%;">
          <nz-tab [nzTitle]="titleQuestions" style="margin-top: -16px;">
            <ng-template #titleQuestions>
              <i nz-icon nzType="ordered-list"></i>Questions / Results
            </ng-template>

            <!-- List header -->
            <nz-page-header style="margin-top: -16px;">
              <nz-page-header-subtitle>Click on question for details</nz-page-header-subtitle>
              <nz-page-header-extra>
                <button nz-button nzType="primary" (click)="showNewPollItemDialog = true">New question</button>
              </nz-page-header-extra>
            </nz-page-header>
            <!-- Poll item list -->
            <nz-collapse class="poll-item-list" nzBordered="false" nzAccordion style="user-select: none;"
                         *ngIf="poll.pollItems !== undefined && poll.pollItems !== null && poll.pollItems.length > 0"
                         cdkDropList (cdkDropListDropped)="drop($event)">
              <nz-collapse-panel class="poll-item" #p *ngFor="let pollItem of poll.pollItems" [nzHeader]="header"
                                 [nzExtra]="options" [nzExpandedIcon]="expandedIcon" cdkDrag>
                <!-- Item content -->
                <p>Test</p>

                <!-- Header -->
                <ng-template #header>
                  <span [style]="'font-size: ' + (p.nzActive ? 'large' : 'small') + '; transition: font-size 0.4s; margin-left: 20px;'">
                    {{pollItem.question}}
                  </span>
                </ng-template>
                <!-- Header options -->
                <ng-template #options>
                  <nz-tag nzColor="default">{{pollItem.type}}</nz-tag>
                  <button  nz-button nzType="primary" [nzSize]="p.nzActive ? 'default' : 'small'"
                           [routerLink]="'/dashboard/my-polls/poll/' + poll.id + '/' + pollItem.id">
                    Details<i nz-icon nzType="right"></i>
                  </button>
                </ng-template>
                <!-- Expand icon -->
                <ng-template #expandedIcon>
                  <i nz-icon class="ant-collapse-arrow"
                     style="font-size: 16px; margin-left: -5px; margin-right: 5px;">
                    <object type="image/svg+xml" data="assets/images/drag_indicator.svg"></object>
                  </i>
                  <i nz-icon nzType="right-circle" class="ant-collapse-arrow" [nzRotate]="p.nzActive ? 90 : 0"
                     style="font-size: 16px; margin-left: 20px;"></i>
                </ng-template>
              </nz-collapse-panel>
            </nz-collapse>

            <!-- No poll items -->
            <app-result-empty *ngIf="poll.pollItems === undefined || poll.pollItems.length === 0"
                              message="You do not have any questions yet."></app-result-empty>
          </nz-tab>
          <nz-tab [nzTitle]="titleAnalytics">
            <ng-template #titleAnalytics>
              <i nz-icon nzType="bar-chart"></i>Analytics
            </ng-template>

            <!-- No results -->
            <app-result-empty *ngIf="poll.pollItems === undefined || poll.pollItems.length === 0 || poll.startDate > currentDate || poll.startDate.getTime() === 0"
                              message="The analytics of your poll are not yet available."></app-result-empty>
          </nz-tab>
          <nz-tab [nzTitle]="titleQA">
            <ng-template #titleQA>
              <i nz-icon nzType="message"></i>Q&A Management
            </ng-template>

            <p>Q&A is up to now far beyond the scope of the application</p>
          </nz-tab>
        </nz-tabset>
      </div>

      <app-new-poll-item-dialog [isVisible]="showNewPollItemDialog" (onClose)="handleNewPollItemDialogClose($event)"
                                [poll]="poll"></app-new-poll-item-dialog>
    </nz-page-header-content>
  </nz-page-header>

  <!-- Loading indicator -->
  <nz-spin *ngIf="!error && poll === undefined" nzSize="large"></nz-spin>

  <!-- Error message -->
  <app-result-error *ngIf="error" title="Error" subtitle="An error occurred while loading the poll"></app-result-error>
</nz-content>
